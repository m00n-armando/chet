<!doctype html>
<html>
  <head>
    <title>CHET - AI Roleplay Chat</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    
    <!-- PWA Tags -->
    <meta name="theme-color" content="#1c1c1e"/>
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CHET">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="CHET - AI Roleplay Chat">
    <meta property="og:description" content="Personal AI roleplay chat experience with dynamic character relationships and immersive conversations">
    <meta property="og:image" content="https://i.imgur.com/wFKuOWB.png">
    <meta property="og:image:width" content="2000">
    <meta property="og:image:height" content="1000">
    <meta property="og:url" content="https://chet-app.netlify.app">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="CHET">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CHET - AI Roleplay Chat">
    <meta name="twitter:description" content="Personal AI roleplay chat experience with dynamic character relationships">
    <meta name="twitter:image" content="https://i.imgur.com/wFKuOWB.png">

    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 50'><text y='35' font-size='32' font-family='Arial, sans-serif' fill='%230a84ff'>CHET</text></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 50'><text y='35' font-size='32' font-family='Arial, sans-serif' fill='%230a84ff'>CHET</text></svg>">

    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^0.15.0"
        }
      }
    </script>
  </head>
  <body>
    <div id="splash-container"></div>
    <main id="app-container">
      <div id="phone-ui">
        <div class="phone-screen">
          <div id="screen-home" class="screen active">
            <header class="home-header">
              <div class="home-header-main">
                <div class="header-left">
                  <img src="https://i.imgur.com/wFKuOWB.png" alt="CHET Logo" class="header-logo" style="height: 5rem; width: auto; max-width: 450px;" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 200 50\'><text y=\'35\' font-size=\'32\' font-family=\'Arial, sans-serif\' fill=\'%23ffffff\'>CHET</text></svg>'">
                </div>
                <div class="header-right">
                  <div class="header-actions">
                    <button id="import-btn" class="header-action-btn" aria-label="Import Data">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"></path></svg>
                    </button>
                    <button id="export-btn" class="header-action-btn" aria-label="Export Data">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                    </button>
                    <button id="settings-btn" class="header-action-btn" aria-label="Open Settings">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                    </button>
                    <input type="file" id="import-file-input" accept=".json,.zip" style="display: none;" />
                  </div>
                  <div id="user-profile-display" class="user-profile-display">Not logged in</div>
                </div>
              </div>
            </header>
            <div id="contact-list" class="contact-list"></div>
            <button id="add-contact-btn" class="fab" aria-label="Add new contact">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path>
              </svg>
            </button>
          </div>

          <div id="screen-create-contact" class="screen">
            <header class="screen-header">
              <button class="back-btn" data-target="home" aria-label="Back to home">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59Z"></path>
                </svg>
              </button>
              <h2>New Character</h2>
            </header>
            <div class="create-contact-body">
              <form id="create-contact-form" class="contact-form">
                  <div class="form-header-with-action">
                    <h4>1. Basic Info</h4>
                    <button type="button" id="reset-creation-btn" class="ai-assist-inline-btn" title="Reset all fields">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"></path></svg>
                        Reset
                    </button>
                  </div>
                  <div class="form-group">
                      <label for="char-name">Name</label>
                      <input type="text" id="char-name" name="char-name" required />
                  </div>
                  <div class="form-group">
                      <label for="char-age">Age</label>
                      <input type="number" id="char-age" name="char-age" required />
                  </div>
                  <div class="form-group">
                      <label for="char-ethnicity">Ethnicity / Descent</label>
                      <input type="text" id="char-ethnicity" name="char-ethnicity" placeholder="e.g., Korean, Japanese" required />
                  </div>
                  <div class="form-group">
                      <label for="char-gender">Gender</label>
                      <select id="char-gender" name="char-gender" required>
                          <option value="female" selected>Female</option>
                          <option value="male">Male</option>
                          <option value="transgender female">Transgender Female</option>
                          <option value="transgender male">Transgender Male</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="char-race">Race</label>
                      <select id="char-race" name="char-race" required>
                          <option value="human" selected>Human</option>
                          <option value="beast human">Beast Human</option>
                          <option value="vampire">Vampire</option>
                          <option value="demon">Demon</option>
                          <option value="angel">Angel</option>
                          <option value="elf">Elf</option>
                          <option value="orc">Orc</option>
                          <option value="fairy">Fairy</option>
                          <option value="werewolf">Werewolf</option>
                          <option value="dragonkin">Dragonkin</option>
                      </select>
                  </div>
                   <div class="form-group">
                      <label for="char-aura">Aura</label>
                      <select id="char-aura" name="char-aura" required>
                          <option value="Bratty" selected>Bratty</option>
                          <option value="Dominant">Dominant</option>
                          <option value="Submissive">Submissive</option>
                          <option value="Intellectual">Intellectual</option>
                          <option value="Nurturing">Nurturing</option>
                          <option value="Charismatic">Charismatic</option>
                          <option value="Analytical">Analytical</option>
                          <option value="Seductive">Seductive</option>
                          <option value="Pampered">Pampered</option>
                          <option value="Adventurous">Adventurous</option>
                          <option value="Ambitious">Ambitious</option>
                          <option value="Empathetic">Empathetic</option>
                      </select>
                  </div>
                   <div class="form-group">
                       <label for="char-roles">Role</label>
                       <select id="char-roles" name="char-roles" required>
                           <option value="new acquaintance" selected>New Acquaintance</option>
                           <option value="childhood friend">Childhood Friend</option>
                           <option value="coworker">Coworker</option>
                           <option value="ex Lover" data-gender="neutral">Ex Lover</option>
                           <option value="step sister" data-gender="female">Step Sister</option>
                           <option value="step brother" data-gender="male">Step Brother</option>
                           <option value="neighbor">Neighbor</option>
                           <option value="classmate">Classmate</option>
                           <option value="fwb/sex partner">FWB / Sex Partner</option>
                           <option value="lover">Lover</option>
                           <option value="girlfriend's step mother">Girlfriend's Step Mother</option>
                           <option value="boyfriend's step father">Boyfriend's Step Father</option>
                           <option value="best friend">Best Friend</option>
                           <option value="roommate">Roommate</option>
                           <option value="boss">Boss</option>
                           <option value="employee">Employee</option>
                           <option value="teacher">Teacher</option>
                           <option value="student">Student</option>
                       </select>
                   </div>
                  <button type="submit" class="submit-btn">Generate Full Profile</button>
              </form>
               <div id="character-preview-panel">
                  <h4>2. Preview & Refine</h4>
                  <div id="avatar-image-container">
                    <img id="avatar-preview-img" src="" alt="Generated character avatar" style="display:none;" />
                    <div id="avatar-placeholder">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88a9.947 9.947 0 0 1 12.28 0C16.43 19.18 14.03 20 12 20z"></path></svg>
                      <span>Your generated character will appear here.</span>
                    </div>
                  </div>
                   <div id="sheet-preview-container" style="display: none;">
                       <p>Profile generated. You can now edit it or generate the avatar.</p>
                       <div class="button-group">
                         <button id="edit-sheet-btn" type="button" class="ai-assist-button">Edit Profile</button>
                         <button id="generate-avatar-btn" type="button" class="ai-assist-button" disabled>Generate Avatar</button>
                       </div>
                   </div>
                  <button type="button" id="save-character-btn" class="submit-btn" style="background-color: #34c759;" disabled>Save Character</button>
              </div>
            </div>
          </div>
          
          <div id="screen-edit-character" class="screen">
            <header class="screen-header editor-header">
                <button class="back-btn" aria-label="Back">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59Z"></path></svg>
                </button>
                <h2>Edit Character</h2>
                <div class="editor-tabs">
                    <button id="editor-avatar-tab" class="editor-tab-btn" data-tab="avatar">Avatar</button>
                    <button id="editor-manager-tab" class="editor-tab-btn active" data-tab="manager">Manager</button>
                </div>
            </header>
            <div id="editor-content-avatar" class="editor-content">
                <div class="editor-avatar-panel">
                    <img id="editor-avatar-img" src="" alt="Character Avatar" class="sheet-avatar" />
                    <button id="editor-change-avatar-btn" class="ai-assist-button" style="margin-bottom: 1rem;">Change Avatar</button>
                    <h4>Avatar Prompt</h4>
                    <p id="editor-avatar-prompt"></p>
                </div>
            </div>
            <div id="editor-content-manager" class="editor-content active">
                <form id="edit-character-form" class="editor-form">
                    <details open>
                        <summary><h3>Basic Info</h3></summary>
                        <div class="form-group"><label for="edit-char-name">Character Name</label><input type="text" id="edit-char-name" /></div>
                        <div class="form-group"><label for="edit-char-username">Username</label><input type="text" id="edit-char-username" /></div>
                        <div class="form-group"><label for="edit-char-bio">Bio (max 150 chars)</label><textarea id="edit-char-bio" maxlength="150" rows="3"></textarea></div>
                        <div class="form-group"><label for="edit-char-age">Age</label><input type="number" id="edit-char-age" /></div>
                        <div class="form-group"><label for="edit-char-zodiac">Zodiac</label><input type="text" id="edit-char-zodiac" /></div>
                        <div class="form-group"><label for="edit-char-ethnicity">Ethnicity</label><input type="text" id="edit-char-ethnicity" /></div>
                        <div class="form-group"><label for="edit-char-gender">Gender</label>
                          <select id="edit-char-gender">
                              <option value="female">Female</option>
                              <option value="male">Male</option>
                              <option value="transgender female">Transgender Female</option>
                              <option value="transgender male">Transgender Male</option>
                          </select>
                        </div>
                        <div class="form-group"><label for="edit-char-race">Race</label>
                          <select id="edit-char-race">
                              <option value="human">Human</option>
                              <option value="beast human">Beast Human</option>
                              <option value="vampire">Vampire</option>
                              <option value="demon">Demon</option>
                              <option value="angel">Angel</option>
                              <option value="elf">Elf</option>
                              <option value="orc">Orc</option>
                              <option value="fairy">Fairy</option>
                              <option value="werewolf">Werewolf</option>
                              <option value="dragonkin">Dragonkin</option>
                          </select>
                        </div>
                        <div class="form-group"><label for="edit-char-cityOfResidence">City of Residence</label><input type="text" id="edit-char-cityOfResidence" /></div>
                        <div class="form-group"><label for="edit-char-aura">Aura</label>
                          <select id="edit-char-aura">
                                <option value="Bratty">Bratty</option>
                                <option value="Dominant">Dominant</option>
                                <option value="Submissive">Submissive</option>
                                <option value="Intellectual">Intellectual</option>
                                <option value="Nurturing">Nurturing</option>
                                <option value="Charismatic">Charismatic</option>
                                <option value="Analytical">Analytical</option>
                                <option value="Seductive">Seductive</option>
                                <option value="Pampered">Pampered</option>
                                <option value="Adventurous">Adventurous</option>
                                <option value="Ambitious">Ambitious</option>
                                <option value="Empathetic">Empathetic</option>
                          </select>
                        </div>
                      <div class="form-group"><label for="edit-char-roles">Role</label>
                        <select id="edit-char-roles">
                          <option value="new acquaintance">New Acquaintance</option>
                          <option value="childhood friend">Childhood Friend</option>
                          <option value="coworker">Coworker</option>
                          <option value="ex Lover" data-gender="neutral">Ex Lover</option>
                          <option value="step sister" data-gender="female">Step Sister</option>
                          <option value="step brother" data-gender="male">Step Brother</option>
                          <option value="neighbor">Neighbor</option>
                          <option value="classmate">Classmate</option>
                          <option value="fwb/sex partner">FWB / Sex Partner</option>
                          <option value="lover">Lover</option>
                          <option value="girlfriend's step mother">Girlfriend's Step Mother</option>
                          <option value="boyfriend's step father">Boyfriend's Step Father</option>
                          <option value="best friend">Best Friend</option>
                          <option value="roommate">Roommate</option>
                          <option value="boss">Boss</option>
                          <option value="employee">Employee</option>
                          <option value="teacher">Teacher</option>
                          <option value="student">Student</option>
                        </select>
                      </div>
                    </details>
                    <details>
                        <summary><h3>Physical & Style</h3></summary>
                        <div class="form-group"><label for="edit-char-bodyType">Body Type</label><textarea id="edit-char-bodyType" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-hairColor">Hair Color</label><input type="text" id="edit-char-hairColor" /></div>
                        <div class="form-group"><label for="edit-char-hairStyle">Hair Style</label><textarea id="edit-char-hairStyle" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-eyeColor">Eye Color</label><input type="text" id="edit-char-eyeColor" /></div>
                        <div class="form-group"><label for="edit-char-skinTone">Skin Tone</label><input type="text" id="edit-char-skinTone" /></div>
                        <div class="form-group"><label for="edit-char-breastAndCleavage">Breast & Cleavage</label><textarea id="edit-char-breastAndCleavage" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-clothingStyle">Clothing Style</label><textarea id="edit-char-clothingStyle" rows="3"></textarea></div>
                        <div class="form-group"><label for="edit-char-accessories">Accessories</label><textarea id="edit-char-accessories" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-makeupStyle">Makeup Style</label><textarea id="edit-char-makeupStyle" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-overallVibe">Overall Vibe</label><textarea id="edit-char-overallVibe" rows="2"></textarea></div>
                    </details>
                    <details>
                        <summary><h3>Personality & Context</h3></summary>
                        <div class="form-group"><label for="edit-char-personalityTraits">Personality Traits</label><textarea id="edit-char-personalityTraits" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-communicationStyle">Communication Style</label><textarea id="edit-char-communicationStyle" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-backgroundStory">Background Story</label><textarea id="edit-char-backgroundStory" rows="4"></textarea></div>
                        <div class="form-group"><label for="edit-char-fatalFlaw">Fatal Flaw</label><textarea id="edit-char-fatalFlaw" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-secretDesire">Secret Desire</label><textarea id="edit-char-secretDesire" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-profession">Profession</label><input type="text" id="edit-char-profession" /></div>
                        <div class="form-group"><label for="edit-char-hobbies">Hobbies</label><textarea id="edit-char-hobbies" rows="2"></textarea></div>
                        <div class="form-group"><label for="edit-char-triggerWords">Trigger Words</label><textarea id="edit-char-triggerWords" rows="2"></textarea></div>
                    </details>
                </form>
            </div>
             <div class="editor-footer">
                <button id="ai-refine-details-btn" class="ai-assist-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="m13.2 22.2-1.9-4.3-4.3-1.9 16-6-6 16ZM11 13l-1.5 3.4L6.1 15 11 13Z"></path></svg>
                    AI Refine Details
                </button>
                <button id="save-character-changes-btn" class="submit-btn">Save Changes</button>
            </div>
          </div>

          <div id="screen-chat" class="screen">
             <header class="screen-header chat-header">
               <button class="back-btn" data-target="home" aria-label="Back to home">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59Z"></path>
                  </svg>
                </button>
                <div id="chat-header-info" title="View Character Details">
                  <img id="chat-header-avatar" class="chat-header-avatar" alt="Character avatar" />
                  <div class="chat-header-details">
                      <h2 id="chat-character-name"></h2>
                      <div id="intimacy-meter" class="hidden">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                          <span id="intimacy-level">0</span>
                      </div>
                      <div id="innate-power-display" class="hidden">
                          <h4 id="innate-power-name"></h4>
                          <p id="innate-power-description"></p>
                      </div>
                  </div>
                </div>
                <button id="toggle-media-panel-btn" aria-label="Toggle media panel">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>
                </button>
             </header>
             <div id="chat-messages" class="chat-messages"></div>
             <footer class="chat-footer">
                <div id="markdown-buttons" class="markdown-buttons hidden">
                  <button class="markdown-btn" data-markdown="*">*</button>
                  <button class="markdown-btn" data-markdown="()">()</button>
                  <button class="markdown-btn" data-markdown="[]">[]</button>
                  <button class="markdown-btn" data-markdown='"'>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="16" height="16">
                      <path d="M12 12a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1h-1.388q0-.527.062-1.054.093-.558.31-.992t.559-.683q.34-.279.868-.279V3q-.868 0-1.52.372a3.3 3.3 0 0 0-1.085.992 4.9 4.9 0 0 0-.62 1.458A7.7 7.7 0 0 0 9 7.558V11a1 1 0 0 0 1 1zm-6 0a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1H5.612q0-.527.062-1.054.094-.558.31-.992t.559-.683q.34-.279.868-.279V3q-.868 0-1.52.372a3.3 3.3 0 0 0-1.085.992 4.9 4.9 0 0 0-.62 1.458A7.7 7.7 0 0 0 3 7.558V11a1 1 0 0 0 1 1z"/>
                    </svg>
                  </button>
                </div>
                <form id="chat-form" class="chat-form">
                    <div class="chat-action-menu">
                        <button type="button" id="chat-action-toggle" aria-label="Toggle chat actions">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"></path></svg>
                        </button>
                        <div class="chat-actions">
                            <button type="button" id="send-photo-btn">Send Photo</button>
                            <button type="button" id="generate-image-btn">Generate Image</button>
                            <button type="button" id="generate-video-btn">Generate Video</button>
                            <button type="button" id="clear-chat-btn" class="destructive">Clear Chat</button>
                            <button type="button" id="delete-character-btn" class="destructive">Delete Character</button>
                        </div>
                    </div>
                <textarea id="chat-input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
                <button type="submit" id="chat-submit-btn" aria-label="Send message">
                </button>
                </form>
             </footer>
          </div>
          <div id="screen-media-gallery" class="screen">
            <header class="screen-header">
              <button class="back-btn" data-target="chat" aria-label="Back to chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59Z"></path>
                </svg>
              </button>
              <h2>Media Gallery</h2>
            </header>
            <div id="media-gallery" class="media-gallery"></div>
          </div>
        </div>
      </div>
    </main>

    <div id="api-key-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Enter API Key</h2>
            <p>To use CHET, you need a free Google Gemini API Key.</p>
            <form id="api-key-form">
                <div class="form-group">
                    <label for="api-key-input">Gemini API Key</label>
                    <input type="password" id="api-key-input" name="api-key-input" required />
                </div>
                <button type="submit" class="submit-btn">Save and Start</button>
            </form>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="help-link">How to get an API Key?</a>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-settings-btn" class="modal-close-btn" aria-label="Close settings">&times;</button>
            <h2>Settings</h2>
            <div class="settings-section">
                <h4>User Profile</h4>
                <p id="settings-user-profile-display">Not logged in</p>
            </div>
            <div class="settings-section">
                <h4>API Key</h4>
                <p id="api-key-display">No key set.</p>
                <button id="clear-api-key-btn" class="submit-btn destructive">Clear & Logout</button>
            </div>
            <div class="settings-section">
                <h4>Features</h4>
                <div class="setting-item">
                    <label for="video-toggle">Enable Video Generation (High Cost)</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="video-toggle">
                        <span class="slider round"></span>
                    </label>
                </div>
                 <div class="setting-item">
                    <label for="intimacy-toggle">Show Intimacy Meter</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="intimacy-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-item">
                   <label for="intimacy-progress-toggle">Show Intimacy Progress Notification</label>
                   <label class="toggle-switch">
                       <input type="checkbox" id="intimacy-progress-toggle" checked>
                       <span class="slider round"></span>
                   </label>
               </div>
            </div>
            <div class="settings-section about-section">
                <h4>About CHET</h4>
                <p>Version 2.2.1</p>
                <div class="changelog-section">
                  <p><strong>Changelog v.2.2.1:</strong></p>
                  <ul>
                    <li>Replace Ghost race with Dragonkin.</li>
                  </ul>
                  <p><strong>Changelog v.2.2.0:</strong></p>
                  <ul>
                    <li>Implement vite-plugin-pwa.</li>
                    <li>Add markdown button.</li>
                  </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="user-profile-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Your Profile</h2>
            <p>Help your AI characters get to know you.</p>
            <form id="user-profile-form">
                <div class="form-group">
                    <label for="user-name">Your Name</label>
                    <input type="text" id="user-name" name="user-name" required />
                </div>
                <div class="form-group">
                    <label for="user-gender">Your Gender</label>
                    <select id="user-gender" name="user-gender" required>
                        <option value="male">Male</option>
                        <option value="female" selected>Female</option>
                        <option value="transgender female">Transgender Female</option>
                        <option value="transgender male">Transgender Male</option>
                        <option value="non-binary">Non-binary</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Save Profile</button>
            </form>
        </div>
    </div>
    
    <div id="loading-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <div class="spinner"></div>
        <p id="loading-text">Please wait...</p>
      </div>
    </div>

    <div id="recording-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
          <div class="recording-visualizer">
              <div class="recording-dot"></div>
          </div>
          <h3 id="recording-timer">00:00</h3>
          <p>Recording... Release to send.</p>
        </div>
    </div>

    <div id="image-viewer-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content image-viewer">
            <div class="viewer-image-container">
              <img id="viewer-img" src="" alt="Zoomed image" />
              <div class="viewer-image-actions">
                <button id="fullscreen-image-btn" class="image-action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg>
                </button>
                <button id="copy-image-btn" class="image-action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                </button>
                <button id="download-image-btn" class="image-action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                </button>
                <button id="edit-image-btn" class="image-action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                </button>
                 <button id="delete-image-btn" class="image-action-btn destructive">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                 </button>
              </div>
            </div>
            <div class="viewer-details-panel">
                <h4>Prompt Details</h4>
                <p id="viewer-img-prompt"></p>
            </div>
            <button id="close-viewer-btn" class="modal-close-btn" aria-label="Close image viewer">&times;</button>
        </div>
    </div>
    
    <div id="video-viewer-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content video-viewer">
            <div class="viewer-video-container">
                <video id="viewer-video" controls autoplay loop playsinline></video>
            </div>
             <div class="viewer-details-panel">
                <h4>Prompt Details</h4>
                <p id="viewer-video-prompt"></p>
            </div>
            <button id="close-video-viewer-btn" class="modal-close-btn" aria-label="Close video viewer">&times;</button>
        </div>
    </div>
    
    <div id="image-retry-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content retry-modal-content">
            <h3>Edit & Retry Generation</h3>
            <p>The previous generation failed. You can edit the prompt and try again.</p>
            <div class="form-group">
                <label class="label-with-button">
                    <span>Reference Image:</span>
                    <button id="retry-select-from-gallery-btn" class="ai-assist-inline-btn">Select from Gallery</button>
                </label>
                <div id="retry-reference-image-dropzone" class="dropzone" tabindex="0">
                    <div class="dropzone-prompt">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span>Drop image, paste, or click to upload</span>
                    </div>
                    <img id="retry-reference-image-preview" src="" alt="Reference image preview" class="hidden" />
                    <button id="retry-remove-reference-image-btn" class="remove-btn hidden" aria-label="Remove reference image">&times;</button>
                    <input type="file" id="retry-reference-image-input" accept="image/*" style="display: none;" />
                </div>
            </div>
            <div class="form-group">
                <label for="retry-prompt-textarea" class="label-with-button">
                    <span>Final Prompt:</span>
                    <button id="ai-refine-retry-prompt-btn" class="ai-assist-inline-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="m13.2 22.2-1.9-4.3-4.3-1.9 16-6-6 16ZM11 13l-1.5 3.4L6.1 15 11 13Z"></path></svg>
                        AI Assist
                    </button>
                </label>
                <textarea id="retry-prompt-textarea"></textarea>
            </div>
            <div class="form-group">
                <label>Safety Level</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="retry-safety-level" value="standard" />
                        <span>Standard</span>
                    </label>
                    <label>
                        <input type="radio" name="retry-safety-level" value="flexible" checked />
                        <span>Flexible</span>
                    </label>
                    <label>
                        <input type="radio" name="retry-safety-level" value="unrestricted" />
                        <span>Unrestricted</span>
                    </label>
                </div>
            </div>
            <div class="button-group">
                <button id="cancel-retry-btn" class="ai-assist-button">Cancel</button>
                <button id="regenerate-image-btn" class="submit-btn">Regenerate</button>
            </div>
        </div>
    </div>

    <div id="image-edit-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content retry-modal-content">
            <h3>Edit Image</h3>
            <p>Describe the changes you want to make to the image.</p>
            <div class="edit-image-preview-container">
                <img id="edit-image-preview" src="" alt="Image to be edited"/>
            </div>
            <div class="form-group">
                <label class="label-with-button">
                    <span>Reference Image (Optional):</span>
                    <button id="edit-select-from-gallery-btn" class="ai-assist-inline-btn">Select from Gallery</button>
                </label>
                <div id="edit-reference-image-dropzone" class="dropzone" tabindex="0">
                    <div class="dropzone-prompt">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span>Drop image, paste, or click to upload</span>
                    </div>
                    <img id="edit-reference-image-preview" src="" alt="Reference image preview" class="hidden" />
                    <button id="edit-remove-reference-image-btn" class="remove-btn hidden" aria-label="Remove reference image">&times;</button>
                    <input type="file" id="edit-reference-image-input" accept="image/*" style="display: none;" />
                </div>
            </div>
            <div class="form-group">
                <label for="edit-instruction-textarea" class="label-with-button">
                    <span>Edit Instruction:</span>
                    <button id="ai-refine-edit-prompt-btn" class="ai-assist-inline-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="m13.2 22.2-1.9-4.3-4.3-1.9 16-6-6 16ZM11 13l-1.5 3.4L6.1 15 11 13Z"></path></svg>
                        AI Assist
                    </button>
                </label>
                <textarea id="edit-instruction-textarea" placeholder="e.g., change her hair to red, add a necklace..."></textarea>
            </div>
             <div class="form-group">
                <label>Safety Level</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="edit-safety-level" value="standard" />
                        <span>Standard</span>
                    </label>
                    <label>
                        <input type="radio" name="edit-safety-level" value="flexible" checked />
                        <span>Flexible</span>
                    </label>
                    <label>
                        <input type="radio" name="edit-safety-level" value="unrestricted" />
                        <span>Unrestricted</span>
                    </label>
                </div>
            </div>
            <div class="button-group">
                <button id="cancel-edit-btn" class="ai-assist-button">Cancel</button>
                <button id="confirm-edit-btn" class="submit-btn">Confirm Edit</button>
            </div>
        </div>
    </div>
    
    <div id="avatar-prompt-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content retry-modal-content">
            <h3>Generate Avatar</h3>
            <p>Review or edit the AI-generated prompt before creating the avatar.</p>
            <div class="form-group">
                <label for="avatar-prompt-textarea">Avatar Prompt:</label>
                <textarea id="avatar-prompt-textarea"></textarea>
            </div>
             <div id="avatar-model-select" class="form-group">
                <label>Generation Model</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="avatar-model" value="gemini-2.5-flash-image-preview" checked />
                        <span>Nano Banana (Fast & Consistent)</span>
                    </label>
                    <label>
                        <input type="radio" name="avatar-model" value="imagen-4.0-generate-001" />
                        <span>Imagen 4.0 (High Quality)</span>
                    </label>
                </div>
            </div>
            <div class="button-group">
                <button id="cancel-generate-avatar-btn" class="ai-assist-button">Cancel</button>
                <button id="confirm-generate-avatar-btn" class="submit-btn">Generate</button>
            </div>
        </div>
    </div>

    <div id="manual-image-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content retry-modal-content">
            <h3>Generate New Image</h3>
            <p>Create a new image from a prompt. You can provide a reference image for better consistency.</p>
            <div class="form-group">
                <label class="label-with-button">
                    <span>Reference Image (Optional):</span>
                    <button id="select-from-gallery-btn" class="ai-assist-inline-btn">Select from Gallery</button>
                </label>
                <div id="reference-image-dropzone" class="dropzone" tabindex="0">
                    <div class="dropzone-prompt">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path></svg>
                        <span>Drop image, paste, or click to upload</span>
                    </div>
                    <img id="reference-image-preview" src="" alt="Reference image preview" class="hidden" />
                    <button id="remove-reference-image-btn" class="remove-btn hidden" aria-label="Remove reference image">&times;</button>
                    <input type="file" id="reference-image-input" accept="image/*" style="display: none;" />
                </div>
            </div>
            <div class="form-group">
                <label for="manual-image-prompt" class="label-with-button">
                    <span>Prompt:</span>
                    <button id="ai-context-prompt-btn" class="ai-assist-inline-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="m13.2 22.2-1.9-4.3-4.3-1.9 16-6-6 16ZM11 13l-1.5 3.4L6.1 15 11 13Z"></path></svg>
                        Use Context
                    </button>
                </label>
                <textarea id="manual-image-prompt" placeholder="A selfie where she is smiling warmly at the camera..."></textarea>
            </div>
            <div id="manual-image-model-select" class="form-group">
                <label>Generation Model</label>
                 <div class="radio-group">
                    <label>
                        <input type="radio" name="image-model" value="gemini-2.5-flash-image-preview" checked />
                        <span>Nano Banana (Fast & Consistent)</span>
                    </label>
                    <label>
                        <input type="radio" name="image-model" value="imagen-4.0-generate-001" />
                        <span>Imagen 4.0 (High Quality)</span>
                    </label>
                </div>
            </div>
            <div id="manual-safety-level-select" class="form-group">
                <label>Safety Level</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="manual-safety-level" value="standard" />
                        <span>Standard</span>
                    </label>
                    <label>
                        <input type="radio" name="manual-safety-level" value="flexible" checked />
                        <span>Flexible</span>
                    </label>
                    <label>
                        <input type="radio" name="manual-safety-level" value="unrestricted" />
                        <span>Unrestricted</span>
                    </label>
                </div>
            </div>
            <div class="button-group">
                <button id="cancel-manual-image-btn" class="ai-assist-button">Cancel</button>
                <button id="confirm-manual-image-btn" class="submit-btn">Generate</button>
            </div>
        </div>
    </div>
    
    <div id="imagen-fallback-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h3>Generation Failed</h3>
        <p>Nano Banana failed to generate an image. This is often due to safety filters. You can try generating again with the more powerful (but slower) Imagen 4.0 model.</p>
        <div class="button-group">
          <button id="cancel-imagen-fallback-btn" class="ai-assist-button">Cancel</button>
          <button id="edit-imagen-fallback-btn" class="ai-assist-button">Edit Prompt</button>
          <button id="confirm-imagen-fallback-btn" class="submit-btn">Use Imagen 4.0</button>
        </div>
      </div>
    </div>

    <div id="reference-gallery-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
            <button id="close-reference-gallery-btn" class="modal-close-btn">&times;</button>
            <h3>Select Reference Image</h3>
            <p style="margin-bottom: 1rem;">Choose an image to guide the generation.</p>
            <div id="reference-gallery-grid" class="reference-grid">
                <!-- Grid items will be populated by JS -->
            </div>
        </div>
    </div>
    
    <div id="avatar-change-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="padding: 0; background: none;">
             <div class="chat-actions" style="position: static; display: block; width: 300px;">
                 <button type="button" id="avatar-change-prompt-btn">Generate with AI Prompt</button>
                 <button type="button" id="avatar-change-upload-btn">Upload from Device</button>
                 <button type="button" id="avatar-change-gallery-btn">Select from Gallery</button>
                 <button type="button" id="cancel-avatar-change-btn" class="destructive">Cancel</button>
             </div>
        </div>
    </div>

    <div id="fullscreen-prompt-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content fullscreen-prompt-content">
            <h3>Edit Prompt</h3>
            <textarea id="fullscreen-prompt-textarea" placeholder="Enter your prompt here..."></textarea>
            <div class="button-group">
                <button id="cancel-fullscreen-prompt-btn" class="ai-assist-button">Cancel</button>
                <button id="save-fullscreen-prompt-btn" class="submit-btn">Save</button>
            </div>
        </div>
    </div>

    <div id="promptRefine-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content retry-modal-content">
            <h3>Refine AI-Generated Prompt</h3>
            <p>The AI has generated a prompt for this image. You can use it as-is, refine it further with AI, edit it manually, or cancel.</p>
            <div class="form-group">
                <label for="refine-prompt-textarea">Generated Prompt:</label>
                <textarea id="refine-prompt-textarea"></textarea>
            </div>
            <div class="button-group">
                <button id="use-refine-prompt-btn" class="submit-btn">Use This Prompt</button>
                <button id="ai-refine-prompt-btn" class="ai-assist-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="m13.2 22.2-1.9-4.3-4.3-1.9 16-6-6 16ZM11 13l-1.5 3.4L6.1 15 11 13Z"></path></svg>
                    Refine with AI
                </button>
                <button id="edit-refine-prompt-btn" class="ai-assist-button">Edit Manually</button>
                <button id="cancel-refine-prompt-btn" class="ai-assist-button">Cancel</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;" />
    <input type="file" id="photo-upload-input" accept="image/*" style="display: none;" />

    <script type="module" src="/index.tsx"></script>
    <link rel="stylesheet" href="/index.css">

    <script>
      // Dynamic viewport height calculation for mobile devices
      function setDynamicViewportHeight() {
        // Calculate the actual viewport height accounting for mobile browser UI
        const vh = window.innerHeight * 0.01;
        const vw = window.innerWidth * 0.01;

        // Set CSS custom properties for accurate viewport calculations
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        document.documentElement.style.setProperty('--vw', `${vw}px`);
        document.documentElement.style.setProperty('--actual-vh', `${window.innerHeight}px`);
        document.documentElement.style.setProperty('--actual-vw', `${window.innerWidth}px`);

        // Also set the height directly on the body for immediate effect
        document.body.style.height = `${window.innerHeight}px`;
      }

      // Set initial height
      setDynamicViewportHeight();

      // Update height on resize and orientation change
      window.addEventListener('resize', setDynamicViewportHeight);
      window.addEventListener('orientationchange', () => {
        // Small delay to ensure the viewport has updated after orientation change
        setTimeout(setDynamicViewportHeight, 100);
      });

      // Handle visual viewport API for better mobile support
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', setDynamicViewportHeight);
      }

      // Service Worker registration (only in production)
      if ('serviceWorker' in navigator && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        window.addEventListener('load', () => {
          // Construct the full URL to the service worker script relative to the current page's location.
          // This avoids issues in environments where the base URL might be misconfigured.
          const swUrl = new URL('/sw.js', location.href).href;

          navigator.serviceWorker.register(swUrl).then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);

            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker available, notify it to skip waiting
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                  }
                });
              }
            });

            // If there's already a waiting service worker, activate it
            if (registration.waiting) {
              registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
          }).catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html>
